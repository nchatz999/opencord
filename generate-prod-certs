#!/usr/bin/env bash
set -euo pipefail
cd "$(dirname "${BASH_SOURCE[0]}")"

CERT_DIR="certs"
mkdir -p "$CERT_DIR"

if [ -z "${1:-}" ]; then
    echo "Usage: $0 <domain>"
    echo "Example: $0 example.com"
    exit 1
fi

DOMAIN="$1"

if ! command -v certbot &> /dev/null; then
    echo "Error: certbot is not installed"
    echo "Install it with: sudo apt install certbot (Debian/Ubuntu)"
    echo "               : sudo dnf install certbot (Fedora)"
    echo "               : sudo pacman -S certbot (Arch)"
    exit 1
fi

echo "Generating Let's Encrypt certificate for $DOMAIN..."

sudo certbot certonly --standalone -d "$DOMAIN" --non-interactive --agree-tos --register-unsafely-without-email

LETSENCRYPT_DIR="/etc/letsencrypt/live/$DOMAIN"
sudo cp "$LETSENCRYPT_DIR/fullchain.pem" "$CERT_DIR/$DOMAIN.crt"
sudo cp "$LETSENCRYPT_DIR/privkey.pem" "$CERT_DIR/$DOMAIN.key"
sudo chown "$USER:$USER" "$CERT_DIR/$DOMAIN.crt" "$CERT_DIR/$DOMAIN.key"
chmod 600 "$CERT_DIR/$DOMAIN.key"

echo ""
echo "Production certificate generated successfully for $DOMAIN"
echo ""
echo "Add the following to your .env file:"
echo "  CERT_PATH=certs/$DOMAIN.crt"
echo "  KEY_PATH=certs/$DOMAIN.key"
echo ""
echo "Let's Encrypt certificates expire in 90 days."
echo "Set up auto-renewal with: sudo certbot renew --dry-run"
